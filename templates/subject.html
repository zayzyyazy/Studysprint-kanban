{% extends "base.html" %}

{% block title %}{{ subject.name }} – StudySprint{% endblock %}

{% block content %}
<section class="page-header">
  <a href="{{ url_for('dashboard') }}" class="back-link">&larr; Dashboard</a>
  <h1>{{ subject.name }}</h1>

  <div class="overall-row">
    <span class="overall-pct">{{ overall_completion }}% complete</span>
    <div class="progress-track progress-track--wide">
      <div class="progress-fill" style="width: {{ overall_completion }}%"></div>
    </div>
  </div>
</section>

{# ── Kanban board ─────────────────────────────────────────────────────── #}
<div class="kanban-board">
  {% for col_key, col in columns.items() %}
  <div class="kanban-column kanban-column--{{ col_key }}">

    <div class="kanban-column__header">
      <h2 class="kanban-column__title">{{ col.label }}</h2>
      <span class="kanban-column__badge">{{ col.topics | length }}</span>
    </div>

    <div class="kanban-cards">
      {% if col.topics %}
        {% for topic in col.topics %}
        <div class="topic-card topic-card--{{ col_key }}">

          {# Title + difficulty badge #}
          <div class="topic-card__top">
            <span class="topic-card__title">{{ topic.title }}</span>
            <span class="topic-card__diff" title="Difficulty {{ topic.difficulty }}/10">
              D{{ topic.difficulty }}
            </span>
          </div>

          {# Completion progress bar #}
          <div class="topic-card__progress-label">
            <span>Completion</span>
            <span>{{ topic.completion }}%</span>
          </div>
          <div class="progress-track">
            <div class="progress-fill progress-fill--{{ col_key }}"
                 style="width: {{ topic.completion }}%"></div>
          </div>

          {# Priority score #}
          <div class="topic-card__priority">
            Priority: <strong>{{ "%.2f"|format(topic.priority) }}</strong>
          </div>

          {# Actions: edit (collapsible) + delete #}
          <div class="topic-card__actions">

            <details class="edit-details">
              <summary class="btn btn--sm btn--secondary">Edit</summary>
              <form method="POST"
                    action="{{ url_for('update_topic', topic_id=topic.id) }}"
                    class="edit-form">
                <div class="form-group">
                  <label class="form-label">Title</label>
                  <input type="text" name="title" value="{{ topic.title }}"
                         required class="form-input form-input--sm" />
                </div>
                <div class="form-row form-row--3">
                  <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <input type="number" name="difficulty"
                           min="1" max="10" value="{{ topic.difficulty }}"
                           class="form-input form-input--sm" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Completion %</label>
                    <input type="number" name="completion"
                           min="0" max="100" value="{{ topic.completion }}"
                           class="form-input form-input--sm" />
                  </div>
                  <div class="form-group">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-input form-input--sm">
                      {% for s in valid_statuses %}
                      <option value="{{ s }}"
                        {% if s == topic.status %}selected{% endif %}>{{ s }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </div>
                <button type="submit" class="btn btn--primary btn--sm">Save</button>
              </form>
            </details>

            <form method="POST"
                  action="{{ url_for('delete_topic', topic_id=topic.id) }}"
                  class="delete-form">
              <button type="submit" class="btn btn--sm btn--danger">Delete</button>
            </form>

          </div>{# /.topic-card__actions #}
        </div>{# /.topic-card #}
        {% endfor %}
      {% else %}
        <p class="kanban-empty">No topics here yet.</p>
      {% endif %}
    </div>{# /.kanban-cards #}

  </div>{# /.kanban-column #}
  {% endfor %}
</div>{# /.kanban-board #}

{# ── Add Topic form ───────────────────────────────────────────────────── #}
<section class="add-panel">
  <h2 class="add-panel__title">Add Topic to {{ subject.name }}</h2>
  <form method="POST"
        action="{{ url_for('add_topic', subject_id=subject.id) }}"
        class="add-form add-form--topic">
    <div class="form-row form-row--topic">
      <div class="form-group form-group--grow">
        <label class="form-label" for="new-title">Title</label>
        <input type="text" id="new-title" name="title"
               placeholder="e.g. Integration Techniques"
               required class="form-input" autocomplete="off" />
      </div>
      <div class="form-group">
        <label class="form-label" for="new-difficulty">Difficulty</label>
        <input type="number" id="new-difficulty" name="difficulty"
               min="1" max="10" value="5" class="form-input form-input--short" />
      </div>
      <div class="form-group">
        <label class="form-label" for="new-completion">Completion %</label>
        <input type="number" id="new-completion" name="completion"
               min="0" max="100" value="0" class="form-input form-input--short" />
      </div>
      <div class="form-group">
        <label class="form-label" for="new-status">Status</label>
        <select id="new-status" name="status" class="form-input">
          {% for s in valid_statuses %}
          <option value="{{ s }}">{{ s }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group form-group--btn">
        <label class="form-label">&nbsp;</label>
        <button type="submit" class="btn btn--primary">+ Add Topic</button>
      </div>
    </div>
  </form>
</section>

{% endblock %}
